trigger: none  # GitHub Actions가 API로 실행시킬 거라 자동 트리거 끔

parameters:
  - name: mode
    type: string
    default: prod
    values:
      - dev
      - prod

  - name: tag
    type: string
    default: ""   # 예: prod-a1b2c3d

variables:
  GHCR_USER: makemeha2
  # GHCR_TOKEN 은 Azure DevOps secret variable(또는 variable group)로 저장해두세요

stages:
- stage: Deploy
  displayName: Deploy only (pull & up)
  jobs:
  - job: DeployJob
    displayName: SSH deploy on VM
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: none

    - bash: |
        set -euo pipefail
        if [ -z "${{ parameters.tag }}" ]; then
          echo "TAG is required"
          exit 1
        fi
        echo "Deploying: mode=${{ parameters.mode }}, tag=${{ parameters.tag }}"
      displayName: Validate inputs

    - task: SSH@0
      displayName: Run deploy.sh on VM
      inputs:
        sshEndpoint: 'heyso-prod-ssh'   # <- SSH 서비스 커넥션 이름
        runOptions: 'commands'
        commands: |
          set -euo pipefail
          cd /opt/heyso/heysoDiaryDeploy
          chmod +x ./scripts/deploy.sh

          # ✅ 토큰은 환경변수로 전달 (로그 노출 위험 감소)
          export GHCR_USER='$(GHCR_USER)'
          export GHCR_TOKEN='$(GHCR_TOKEN)'

          # deploy.sh는 인자로도 받을 수 있고(호환), 환경변수도 사용할 수 있게 구성 권장
          ./scripts/deploy.sh '${{ parameters.mode }}' '${{ parameters.tag }}'
