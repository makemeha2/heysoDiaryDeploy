trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: backend
      type: github
      name: makemeha2/HeysoDiaryBackEnd
      endpoint: makemeha2
      ref: refs/heads/main
    - repository: frontend
      type: github
      name: makemeha2/HeysoDiaryFrontEnd
      endpoint: makemeha2
      ref: refs/heads/main

variables:
  GHCR_REGISTRY: ghcr.io
  GHCR_NAMESPACE: makemeha2
  API_IMAGE: heyso-diary-api
  WEB_IMAGE: heyso-diary-web

stages:
- stage: BuildPushDeployProd
  displayName: Build & Push & Deploy (Self-hosted)
  jobs:
  - job: BuildPushDeploy
    displayName: Build/Push images then deploy on VM
    pool:
      name: heyso-deploy-prod

    steps:
    - checkout: backend
      path: backend

    - checkout: frontend
      path: frontend

    - bash: |
        set -euo pipefail
        SHORT=$(echo "$(Build.SourceVersion)" | cut -c1-7)
        TAG="prod-${SHORT}"
        echo "##vso[task.setvariable variable=TAG]$TAG"
        echo "TAG=$TAG"
      displayName: Set TAG

    - bash: |
        set -euo pipefail
        echo "$(GHCR_TOKEN)" | docker login $(GHCR_REGISTRY) -u "$(GHCR_USER)" --password-stdin
      displayName: Docker login (GHCR)

    - bash: |
        set -euo pipefail
        docker build -t $(GHCR_REGISTRY)/$(GHCR_NAMESPACE)/$(API_IMAGE):$(TAG) "$(Pipeline.Workspace)/backend"
        docker push $(GHCR_REGISTRY)/$(GHCR_NAMESPACE)/$(API_IMAGE):$(TAG)
      displayName: Build & Push Backend

    - bash: |
        set -euo pipefail
        docker build \
          --build-arg VITE_GOOGLE_CLIENT_ID="$(VITE_GOOGLE_CLIENT_ID)" \
          --build-arg VITE_API_BASE_URL="$(VITE_API_BASE_URL)" \
          --build-arg VITE_APP_ENV="PROD" \
          -t $(GHCR_REGISTRY)/$(GHCR_NAMESPACE)/$(WEB_IMAGE):$(TAG) \
          "$(Pipeline.Workspace)/frontend"
        docker push $(GHCR_REGISTRY)/$(GHCR_NAMESPACE)/$(WEB_IMAGE):$(TAG)
      displayName: Build & Push Frontend

    - bash: |
        set -euo pipefail
        cd /opt/heyso/heysoDiaryDeploy
        chmod +x ./scripts/deploy.sh
        ./scripts/deploy.sh prod $(TAG) $(GHCR_USER) $(GHCR_TOKEN)
      displayName: Deploy on VM (compose pull + up)
