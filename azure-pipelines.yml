trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: backend
      type: github
      name: makemeha2/HeysoDiaryBackEnd
      endpoint: GITHUB_SERVICE_CONNECTION
      ref: refs/heads/main
      trigger:
        branches:
          include:
            - main

    - repository: frontend
      type: github
      name: makemeha2/HeysoDiaryFrontEnd
      endpoint: GITHUB_SERVICE_CONNECTION
      ref: refs/heads/main
      trigger:
        branches:
          include:
            - main

variables:
  GHCR_REGISTRY: ghcr.io
  GHCR_NAMESPACE: makemeha2

  API_IMAGE: heyso-diary-api
  WEB_IMAGE: heyso-diary-web

stages:
- stage: BuildAndPush
  displayName: Build & Push Images (PROD)
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
      path: deploy

    - checkout: backend
      path: backend

    - checkout: frontend
      path: frontend

    - bash: |
        set -euo pipefail
        SHORT=$(echo "$(Build.SourceVersion)" | cut -c1-7)
        TAG="prod-${SHORT}"
        echo "##vso[task.setvariable variable=TAG]$TAG"
        echo "TAG=$TAG"
      displayName: Set image TAG (prod-<sha>)

    - bash: |
        set -euo pipefail
        echo "$(GHCR_TOKEN)" | docker login $(GHCR_REGISTRY) -u "$(GHCR_USER)" --password-stdin
      displayName: Docker login (GHCR)

    - bash: |
        set -euo pipefail
        docker build \
          -t $(GHCR_REGISTRY)/$(GHCR_NAMESPACE)/$(API_IMAGE):$(TAG) \
          "$(Build.SourcesDirectory)/backend"
        docker push $(GHCR_REGISTRY)/$(GHCR_NAMESPACE)/$(API_IMAGE):$(TAG)
      displayName: Build & Push Backend image

    - bash: |
        set -euo pipefail
        docker build \
          --build-arg VITE_GOOGLE_CLIENT_ID="$(VITE_GOOGLE_CLIENT_ID)" \
          --build-arg VITE_API_BASE_URL="$(VITE_API_BASE_URL)" \
          --build-arg VITE_APP_ENV="PROD" \
          -t $(GHCR_REGISTRY)/$(GHCR_NAMESPACE)/$(WEB_IMAGE):$(TAG) \
          "$(Build.SourcesDirectory)/frontend"
        docker push $(GHCR_REGISTRY)/$(GHCR_NAMESPACE)/$(WEB_IMAGE):$(TAG)
      displayName: Build & Push Frontend image

- stage: DeployProd
  displayName: Deploy to PROD VM
  dependsOn: BuildAndPush
  condition: succeeded()
  jobs:
  - job: Deploy
    pool:
      vmImage: ubuntu-latest
    steps:
    - bash: |
        set -euo pipefail
        SHORT=$(echo "$(Build.SourceVersion)" | cut -c1-7)
        TAG="prod-${SHORT}"
        echo "##vso[task.setvariable variable=TAG]$TAG"
        echo "Deploy TAG=$TAG"
      displayName: Set deploy TAG

    - bash: |
        set -euo pipefail
        mkdir -p ~/.ssh
        echo "$(PROD_SSH_PRIVATE_KEY)" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "$(PROD_SSH_HOST)" >> ~/.ssh/known_hosts
      displayName: Setup SSH

    - bash: |
        set -euo pipefail
        ssh -i ~/.ssh/id_rsa "$(PROD_SSH_USER)@$(PROD_SSH_HOST)" \
          "cd /opt/heyso/heysoDiaryDeploy && ./scripts/deploy.sh prod $(TAG) $(GHCR_USER) $(GHCR_TOKEN)"
      displayName: Deploy (pull + compose up)
