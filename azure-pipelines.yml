trigger: none  # GitHub Actions가 API로 실행시킬 거라 자동 트리거 끔

parameters:
  - name: mode
    type: string
    default: prod
    values:
      - dev
      - prod

  - name: tag
    type: string
    default: ""   # 예: prod-a1b2c3d

variables:
  GHCR_USER: makemeha2
  # GHCR_TOKEN 은 Azure DevOps secret variable(또는 variable group)로 저장해두세요

stages:
- stage: Deploy
  displayName: Deploy only (pull & up)
  jobs:
  - job: DeployJob
    displayName: SSH deploy on VM
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: none

    - bash: |
        set -euo pipefail
        if [ -z "${{ parameters.tag }}" ]; then
          echo "TAG is required"
          exit 1
        fi
        echo "Deploying: mode=${{ parameters.mode }}, tag=${{ parameters.tag }}"
      displayName: Validate inputs

    - task: SSH@0
      displayName: Debug paths on VM
      inputs:
        sshEndpoint: 'heyso-prod-ssh'   # 실제 SSH 서비스 커넥션 이름
        runOptions: 'commands'
        commands: |
          set -euo pipefail
          echo "whoami=$(whoami)"
          echo "pwd=$(pwd)"
          echo "hostname=$(hostname)"
          echo "ip=$(hostname -I || true)"
          ls -al /opt/heyso || true
          ls -al /opt/heyso/heysoDiaryDeploy || true
          cd /opt/heyso/heysoDiaryDeploy
          echo "after cd, pwd=$(pwd)"
          ls -al
          ls -al scripts || true
          find . -maxdepth 3 -type f -name "deploy.sh" -print

